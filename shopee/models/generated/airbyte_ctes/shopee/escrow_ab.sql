{{ config(
    cluster_by = ["_AIRBYTE_EMITTED_AT"],
    unique_key = '_AIRBYTE_AB_ID',
    tags = [ "top-level-intermediate" ]
) }}

select
    (_airbyte_data::json ->'data'->  '_airbyte_data' -> 'escrow detail' ->> 'order_sn')::text AS order_sn,
    (_airbyte_data::json ->'data'->  '_airbyte_data'-> 'escrow detail' -> 'order_income' ->> 'coins')::decimal as coins,
    (_airbyte_data::json ->'data'->  '_airbyte_data'-> 'escrow detail' -> 'order_income' ->> 'items')::json as order_items,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'escrow_tax')::decimal as escrow_tax,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'service_fee')::decimal as service_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'campaign_fee')::decimal as campaign_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'escrow_amount')::decimal as escrow_amount,    
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'commission_fee')::decimal as commission_fee,    
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'instalment_plan')::text as instalment_plan,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'cross_border_tax')::decimal as cross_border_tax,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'payment_promotion')::decimal as payment_promotion,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'buyer_total_amount')::decimal as buyer_total_amount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'cost_of_goods_sold')::decimal as cost_of_goods_sold,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'final_shipping_fee')::decimal as final_shipping_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'actual_shipping_fee')::decimal as actual_shipping_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'order_selling_price')::decimal as order_selling_price,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'seller_voucher_code')::json as seller_voucher_code,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'voucher_from_seller')::decimal as voucher_from_seller,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'voucher_from_shopee')::decimal as voucher_from_shopee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'buyer_payment_method')::text as buyer_payment_method,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'order_original_price')::decimal as order_original_price,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'reverse_shipping_fee')::decimal as reverse_shipping_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'seller_return_refund')::decimal as seller_return_refund,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'buyer_transaction_fee')::decimal as buyer_transaction_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'credit_card_promotion')::decimal as credit_card_promotion,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'drc_adjustable_refund')::decimal as drc_adjustable_refund,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'final_product_vat_tax')::decimal as final_product_vat_tax,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'order_seller_discount')::decimal as order_seller_discount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'seller_coin_cash_back')::decimal as seller_coin_cash_back,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'estimated_shipping_fee')::decimal as estimated_shipping_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'final_shipping_vat_tax')::decimal as final_shipping_vat_tax,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'order_discounted_price')::decimal as order_discounted_price,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail'-> 'order_income' ->> 'seller_transaction_fee')::decimal as seller_transaction_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'shopee_shipping_rebate')::decimal as shopee_shipping_rebate,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'buyer_paid_shipping_fee')::decimal as buyer_paid_shipping_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'order_chargeable_weight')::numeric as order_chargeable_weight,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'total_adjustment_amount')::decimal as total_adjustment_amount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'final_escrow_product_gst')::decimal as final_escrow_product_gst,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'final_product_protection')::decimal as final_product_protection,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'order_ams_commission_fee')::decimal as order_ams_commission_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'original_shopee_discount')::decimal as original_shopee_discount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'seller_lost_compensation')::decimal as seller_lost_compensation,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'seller_shipping_discount')::decimal as seller_shipping_discount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'final_escrow_shipping_gst')::decimal as final_escrow_shipping_gst,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'credit_card_transaction_fee')::decimal as credit_card_transaction_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'original_cost_of_goods_sold')::decimal as original_cost_of_goods_sold,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'escrow_amount_after_adjustment')::decimal as escrow_amount_after_adjustment,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'shipping_fee_discount_from_3pl')::decimal as shipping_fee_discount_from_3pl,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'final_return_to_seller_shipping_fee')::decimal as final_return_to_seller_shipping_fee,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'shipping_seller_protection_fee_amount')::decimal as shipping_seller_protection_fee_amount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'fsf_seller_protection_fee_claim_amount')::decimal as fsf_seller_protection_fee_claim_amount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'rsf_seller_protection_fee_claim_amount')::decimal as rsf_seller_protection_fee_claim_amount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'prorated_coins_value_offset_return_items')::decimal as prorated_coins_value_offset_return_items,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'prorated_shopee_voucher_offset_return_items')::decimal as prorated_shopee_voucher_offset_return_items,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' -> 'order_income' ->> 'delivery_seller_protection_fee_premium_amount')::decimal as delivery_seller_protection_fee_premium_amount,
    (_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail'  ->> 'buyer_user_name')::text as buyer_user_name,
    translate((_airbyte_data::json ->'data'-> '_airbyte_data' -> 'escrow detail' ->> 'return_order_sn_list'), '[]', '{}')::text[] AS return_order_sn_list,
    (_airbyte_data::json ->'data'-> '_airbyte_data'  ->> 'payout_amount')::decimal as payout_amount,
    to_timestamp((_airbyte_data::json ->'data'-> '_airbyte_data'  ->> 'escrow_release_time')::numeric) AT TIME ZONE 'UTC' as escrow_release_time,
    _airbyte_ab_id as _AIRBYTE_AB_ID,
    _airbyte_emitted_at as _AIRBYTE_EMITTED_AT,
    {{ current_timestamp() }} as _AIRBYTE_NORMALIZED_AT
from {{source( 'shopee','escrow' )}}

where 1 = 1
{{ incremental_clause('_AIRBYTE_EMITTED_AT', this) }}